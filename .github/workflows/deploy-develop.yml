name: Deploy Para Ambiente de Homologa√ß√£o

on:
  pull_request:
    branches:
    - develop

jobs:
  deploy-develop:
    runs-on: [self-hosted, develop-runner]

    steps:
    # --- In√≠cio da Limpeza do Workspace ---
    - name: Limpar workspace do self-hosted runner
      run: |
        echo "üßπ Limpando workspace anterior..."
        pwd
        rm -rf ./* ./.* 2>/dev/null || true
        echo "‚úÖ Workspace limpo"
        
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      with: 
        fetch-depth: 0
        clean: true

    - name: Verificar estrutura do projeto
      run: |
        echo "üìÇ Verificando estrutura do projeto..."
        ls -la
        echo ""
        echo "üìÅ Backend directory:"
        ls -la backend/
        echo ""
        echo "üìÅ Frontend directory:"  
        ls -la frontend/
        echo "‚úÖ Estrutura verificada com sucesso"
    # --- Fim da Limpeza do Workspace ---

    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # --- In√≠cio das Etapas de Versionamento Autom√°tico ---

    - name: Instalar depend√™ncias do backend para versionamento
      working-directory: ./backend
      run: npm install

    - name: Gerar nova vers√£o para o backend
      working-directory: ./backend
      run: |
        npm run release -- --prerelease develop --skip.tag --no-verify
        # --prerelease develop: Cria vers√µes de pr√©-lan√ßamento (ex: 1.0.0-develop.0)
        # --skip.tag: Evita que o standard-version crie uma tag individual, faremos o push de tags no final
        # --no-verify: Evita que ganchos de git (pre-commit) impe√ßam o versionamento

    - name: Instalar depend√™ncias do frontend para versionamento
      working-directory: ./frontend
      run: npm install

    - name: Gerar nova vers√£o para o frontend
      working-directory: ./frontend
      run: npm run release -- --prerelease develop --skip.tag --no-verify

    - name: Configurar Git para commit de vers√£o
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"

    - name: Commitar as novas vers√µes e CHANGELOGs
      run: |
        git add .
        # [skip ci] no commit message √© CRUCIAL para evitar um loop infinito de workflows
        git commit -m "chore(release): [skip ci] versionamento autom√°tico para develop"

    - name: Push das altera√ß√µes de vers√£o e tags
      run: |
        git push origin develop
        git push --tags origin develop

    # --- Fim das Etapas de Versionamento Autom√°tico ---

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Backend Docker image
      run: |
        docker build -t contacts-backend-homolog:latest ./backend
         
    - name: Build and push Frontend Docker image
      run: |
        docker build -t contacts-frontend-homolog:latest --build-arg REACT_APP_API_BASE_URL=http://contacts-backend-homolog:${{ secrets.BACKEND_PORT_DEV }}/api ./frontend

    - name: Parar e remover containers antigos
      run: |
        docker stop contacts-frontend-homolog contacts-backend-homolog contacts-db-homolog || true
        docker rm contacts-frontend-homolog contacts-backend-homolog contacts-db-homolog || true

    - name: Subir novos containers
      run: |
        # Usando secrets para as vari√°veis do PostgreSQL
        docker run -d --name contacts-db-homolog \
          -e POSTGRES_USER=${{ secrets.POSTGRES_USER_DEV }} \
          -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_DEV }} \
          -e POSTGRES_DB=${{ secrets.POSTGRES_DB_DEV }} \
          -v contacts_data_homolog:/var/lib/postgresql/data \
          postgres:13-alpine

        # Usando secrets para as vari√°veis do Backend
        docker run -d --name contacts-backend-homolog \
          -p ${{ secrets.BACKEND_PORT_DEV }}:${{ secrets.BACKEND_PORT_DEV }} \
          --env PORT=${{ secrets.BACKEND_PORT_DEV }} \
          --env DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER_DEV }}:${{ secrets.POSTGRES_PASSWORD_DEV }}@contacts-db-homolog:5432/${{ secrets.POSTGRES_DB_DEV }} \
          --env JWT_SECRET=${{ secrets.JWT_SECRET_DEV }} \
          --env JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN_DEV }} \
          --link contacts-db-homolog:contacts-db-homolog \
          contacts-backend-homolog:latest

        # O frontend j√° tem a API_BASE_URL no build-arg, ent√£o n√£o precisa passar aqui
        docker run -d --name contacts-frontend-homolog -p 80:80 contacts-frontend-homolog:latest
         
        # Mensagem ap√≥s todos os containers serem iniciados
        echo "üöÄ Deployment para o ambiente de Homologa√ß√£o conclu√≠do!"

    - name: Remover imagens antigas
      run: |
        docker rmi contacts-backend-homolog:latest contacts-frontend-homolog:latest || true

    - name: Verifica√ß√£o de status das imagens Docker
      run: |
        echo "üìä Status dos containers:"
        docker ps -a
        echo ""
        echo "üéâ Deployment para o ambiente de Homologa√ß√£o conclu√≠do com sucesso!"
