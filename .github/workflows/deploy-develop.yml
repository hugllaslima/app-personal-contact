name: Deploy Para Ambiente de Homologa√ß√£o

on:
  pull_request:
    branches:
    - develop

jobs:
  deploy-develop:
    runs-on: [self-hosted, develop-runner]

    steps:
    - name: Limpar workspace do self-hosted runner
      run: |
        echo "üßπ Limpando workspace anterior..."
        pwd
        rm -rf ./* ./.* 2>/dev/null || true
        echo "‚úÖ Workspace limpo"
        
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      with: 
        fetch-depth: 0
        clean: true

    - name: Verificar estrutura do projeto
      run: |
        echo "üìÇ Verificando estrutura do projeto..."
        ls -la
        echo ""
        echo "üìÅ Backend directory (Python):"
        ls -la backend/
        echo ""
        echo "üìÅ Frontend directory (Node.js):"  
        ls -la frontend/
        echo "‚úÖ Estrutura verificada com sucesso"

    # CONFIGURAR PYTHON PARA O BACKEND
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # ou a vers√£o que voc√™ usa

    # CONFIGURAR NODE.JS PARA O FRONTEND
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # --- In√≠cio das Etapas de Versionamento Autom√°tico ---

    # BACKEND PYTHON - Instalar depend√™ncias
    - name: Instalar depend√™ncias do backend Python
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt  # ou: pip install .

    # BACKEND PYTHON - Versionamento (se voc√™ usar uma ferramenta como bump2version)
    - name: Gerar nova vers√£o para o backend Python
      working-directory: ./backend
      run: |
        # Se voc√™ usar bump2version ou similar:
        # pip install bump2version
        # bump2version --current-version $(grep version pyproject.toml | cut -d'"' -f2) patch --allow-dirty
        # 
        # Ou se usar poetry:
        # poetry version prerelease
        #
        # Por enquanto, vou comentar at√© voc√™ definir a ferramenta:
        echo "Versionamento Python - configure conforme sua ferramenta"

    # FRONTEND NODE.JS - Continua igual
    - name: Instalar depend√™ncias do frontend para versionamento
      working-directory: ./frontend
      run: npm install

    - name: Gerar nova vers√£o para o frontend
      working-directory: ./frontend
      run: npm run release -- --prerelease develop --skip.tag --no-verify

    - name: Configurar Git para commit de vers√£o
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"

    - name: Commitar as novas vers√µes e CHANGELOGs
      run: |
        git add .
        git commit -m "chore(release): [skip ci] versionamento autom√°tico para develop"

    - name: Push das altera√ß√µes de vers√£o e tags
      run: |
        git push origin develop
        git push --tags origin develop

    # --- Fim das Etapas de Versionamento Autom√°tico ---

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Backend Docker image (Python)
      run: |
        docker build -t contacts-backend-homolog:latest ./backend
         
    - name: Build and push Frontend Docker image (Node.js)
      run: |
        docker build -t contacts-frontend-homolog:latest --build-arg REACT_APP_API_BASE_URL=http://contacts-backend-homolog:${{ secrets.BACKEND_PORT_DEV }}/api ./frontend

    - name: Parar e remover containers antigos
      run: |
        docker stop contacts-frontend-homolog contacts-backend-homolog contacts-db-homolog || true
        docker rm contacts-frontend-homolog contacts-backend-homolog contacts-db-homolog || true

    - name: Subir novos containers
      run: |
        # Usando secrets para as vari√°veis do PostgreSQL
        docker run -d --name contacts-db-homolog \
          -e POSTGRES_USER=${{ secrets.POSTGRES_USER_DEV }} \
          -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_DEV }} \
          -e POSTGRES_DB=${{ secrets.POSTGRES_DB_DEV }} \
          -v contacts_data_homolog:/var/lib/postgresql/data \
          postgres:13-alpine

        # Usando secrets para as vari√°veis do Backend Python
        docker run -d --name contacts-backend-homolog \
          -p ${{ secrets.BACKEND_PORT_DEV }}:${{ secrets.BACKEND_PORT_DEV }} \
          --env PORT=${{ secrets.BACKEND_PORT_DEV }} \
          --env DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER_DEV }}:${{ secrets.POSTGRES_PASSWORD_DEV }}@contacts-db-homolog:5432/${{ secrets.POSTGRES_DB_DEV }} \
          --env JWT_SECRET=${{ secrets.JWT_SECRET_DEV }} \
          --env JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN_DEV }} \
          --link contacts-db-homolog:contacts-db-homolog \
          contacts-backend-homolog:latest

        # Frontend Node.js
        docker run -d --name contacts-frontend-homolog -p 80:80 contacts-frontend-homolog:latest
         
        echo "üöÄ Deployment para o ambiente de Homologa√ß√£o conclu√≠do!"

    - name: Remover imagens antigas
      run: |
        docker rmi contacts-backend-homolog:latest contacts-frontend-homolog:latest || true

    - name: Verifica√ß√£o de status das imagens Docker
      run: |
        echo "üìä Status dos containers:"
        docker ps -a
        echo ""
        echo "üéâ Deployment para o ambiente de Homologa√ß√£o conclu√≠do com sucesso!"
